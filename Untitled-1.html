const STORAGE_KEY = "hudol_mini_app_v1";

function loadState() {
  try {
    const raw = localStorage.getItem(STORAGE_KEY);
    if (!raw) {
      return {
        weight: "",
        checks: { protein2: false, steps6000: false, noFries: false },
        notes: "",
      };
    }
    return JSON.parse(raw);
  } catch {
    return {
      weight: "",
      checks: { protein2: false, steps6000: false, noFries: false },
      notes: "",
    };
  }
}

function saveState(state) {
  localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
}

let state = loadState();

function render() {
  document.querySelector("#app").innerHTML = `
    <div style="max-width:720px;margin:40px auto;font-family:system-ui;padding:16px;">
      <h1 style="margin:0 0 8px;">íœ´ëŒ ë¯¸ë‹ˆ ì›¹ì•± ğŸš€</h1>
      <p style="margin:0 0 20px;opacity:.8;">ì²´í¬ + ì²´ì¤‘ + ë©”ëª¨ê°€ <b>ë¸Œë¼ìš°ì €ì— ì €ì¥</b>ë¼ì„œ ìƒˆë¡œê³ ì¹¨í•´ë„ ë‚¨ì•„.</p>

      <section style="padding:16px;border:1px solid #ddd;border-radius:12px;margin-bottom:16px;">
        <h2 style="margin:0 0 12px;font-size:18px;">ì˜¤ëŠ˜ ì²´í¬</h2>
        ${checkboxRow("protein2", "ë‹¨ë°±ì§ˆ 2ë²ˆ í–ˆë‚˜")}
        ${checkboxRow("steps6000", "6,000ë³´ í–ˆë‚˜")}
        ${checkboxRow("noFries", "ë²„ê±° ë¨¹ì–´ë„ ê°íŠ€ X")}
      </section>

      <section style="padding:16px;border:1px solid #ddd;border-radius:12px;margin-bottom:16px;">
        <h2 style="margin:0 0 12px;font-size:18px;">ì²´ì¤‘ ê¸°ë¡</h2>
        <div style="display:flex;gap:8px;align-items:center;">
          <input id="weight" inputmode="decimal" placeholder="ì˜ˆ: 81.0"
            value="${escapeHtml(state.weight)}"
            style="flex:1;padding:10px;border:1px solid #ccc;border-radius:10px;font-size:16px;" />
          <button id="saveWeight" style="padding:10px 14px;border:1px solid #222;border-radius:10px;background:#222;color:#fff;">
            ì €ì¥
          </button>
        </div>
        <p style="margin:10px 0 0;opacity:.8;">í˜„ì¬ ì €ì¥ëœ ì²´ì¤‘: <b>${escapeHtml(state.weight || "-")}</b></p>
      </section>

      <section style="padding:16px;border:1px solid #ddd;border-radius:12px;margin-bottom:16px;">
        <h2 style="margin:0 0 12px;font-size:18px;">ë©”ëª¨</h2>
        <textarea id="notes" rows="4" placeholder="ì˜¤ëŠ˜ í•œ ì¤„ ë©”ëª¨..."
          style="width:100%;padding:10px;border:1px solid #ccc;border-radius:10px;font-size:14px;">${escapeHtml(
            state.notes
          )}</textarea>
        <div style="display:flex;gap:8px;margin-top:10px;">
          <button id="saveNotes" style="padding:10px 14px;border:1px solid #222;border-radius:10px;background:#222;color:#fff;">
            ë©”ëª¨ ì €ì¥
          </button>
          <button id="resetAll" style="padding:10px 14px;border:1px solid #ccc;border-radius:10px;background:#fff;">
            ì „ì²´ ì´ˆê¸°í™”
          </button>
        </div>
      </section>

      <section style="padding:16px;border:1px solid #ddd;border-radius:12px;">
        <h2 style="margin:0 0 12px;font-size:18px;">ì˜¤ëŠ˜ ì ìˆ˜</h2>
        <p style="margin:0;font-size:28px;"><b>${score()}</b> / 3</p>
        <p style="margin:8px 0 0;opacity:.8;">(ì²´í¬ 3ê°œ ê¸°ì¤€)</p>
      </section>

      <p style="margin:18px 0 0;opacity:.6;font-size:12px;">
        ì €ì¥ì€ localStorage(ì´ ë¸Œë¼ìš°ì €) ê¸°ë°˜ì´ì•¼.
      </p>
    </div>
  `;

  wireEvents();
}

function checkboxRow(key, label) {
  const checked = state.checks[key] ? "checked" : "";
  return `
    <label style="display:flex;gap:10px;align-items:center;margin:8px 0;cursor:pointer;">
      <input type="checkbox" data-key="${key}" ${checked} style="transform:scale(1.2);" />
      <span>${label}</span>
    </label>
  `;
}

function score() {
  return Object.values(state.checks).filter(Boolean).length;
}

function wireEvents() {
  document.querySelectorAll('input[type="checkbox"][data-key]').forEach((el) => {
    el.addEventListener("change", (e) => {
      const key = e.target.getAttribute("data-key");
      state.checks[key] = e.target.checked;
      saveState(state);
      render();
    });
  });

  document.querySelector("#saveWeight").addEventListener("click", () => {
    const v = document.querySelector("#weight").value.trim();
    state.weight = v;
    saveState(state);
    render();
  });

  document.querySelector("#saveNotes").addEventListener("click", () => {
    const v = document.querySelector("#notes").value;
    state.notes = v;
    saveState(state);
    render();
  });

  document.querySelector("#resetAll").addEventListener("click", () => {
    localStorage.removeItem(STORAGE_KEY);
    state = loadState();
    render();
  });
}

// ì•„ì£¼ ë‹¨ìˆœí•œ HTML escape
function escapeHtml(s) {
  return String(s)
    .replaceAll("&", "&amp;")
    .replaceAll("<", "&lt;")
    .replaceAll(">", "&gt;")
    .replaceAll('"', "&quot;")
    .replaceAll("'", "&#039;");
}

render();

